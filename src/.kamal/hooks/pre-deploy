#!/bin/sh
# Check GitHub commit status "tests" before deploying. If "success", skip tests. If not, run tests locally.
# If tests pass, set GitHub status "tests" to "success". If they fail set it to "failure".

set -eu

if [ -z "${GITHUB_TOKEN:-}" ]; then
  echo "ERROR: GITHUB_TOKEN is not set"
  exit 1
fi

if [ -z "${KAMAL_VERSION:-}" ]; then
  echo "ERROR: KAMAL_VERSION is not set (commit SHA)"
  exit 1
fi

GITHUB_REPOSITORY=$(git remote get-url origin | sed 's/\.git$//' | sed -E 's#.*/([^/]+/[^/]+)#\1#')
echo "Detected repository: $GITHUB_REPOSITORY"

SHA="$KAMAL_VERSION"
REPO="$GITHUB_REPOSITORY"

echo "=== Pre-deploy hook started ==="
echo "Repo: $REPO"
echo "Commit SHA: $SHA"

###############################################################################
# 1) Check GitHub commit status "tests"
###############################################################################

echo "Checking GitHub commit status 'tests'..."

STATUS_JSON=$(curl -s \
    -H "Authorization: Bearer $GITHUB_TOKEN" \
    -H "Accept: application/vnd.github+json" \
    "https://api.github.com/repos/$REPO/commits/$SHA/status")

CURRENT_STATE=$(echo "$STATUS_JSON" \
  | jq -r '.statuses // [] | map(select(.context=="tests") | .state)[]?' )

if [ "$CURRENT_STATE" = "success" ]; then
  echo "GitHub commit status 'tests' = success → skipping tests"
  exit 0
fi

echo "No success status found → running tests locally..."

###############################################################################
# 2) Run tests from a temp directory with a new checkout 
###############################################################################

if [ ! -x "./run-tests.sh" ]; then
  echo "ERROR: ./run-tests.sh not found or not executable"
  exit 1
fi

echo "Executing ./run-tests.sh ..."

set +e
./run-tests.sh
TEST_EXIT=$?
set -e

if [ "$TEST_EXIT" -ne 0 ]; then
  echo "Tests FAILED (exit code $TEST_EXIT)"
  echo "Setting GitHub status 'tests' = failure"

  curl -s -X POST \
      -H "Authorization: Bearer $GITHUB_TOKEN" \
      -H "Accept: application/vnd.github+json" \
      -d "{\"state\":\"failure\", \"context\":\"tests\", \"description\":\"Docker CI tests failed\"}" \
      "https://api.github.com/repos/$REPO/statuses/$SHA" >/dev/null

  exit 1
fi

echo "Tests PASSED → setting GitHub commit status 'tests' to success"

###############################################################################
# 3) Set GitHub commit status "tests" to "success"
###############################################################################

curl -s -X POST \
    -H "Authorization: Bearer $GITHUB_TOKEN" \
    -H "Accept: application/vnd.github+json" \
    -d "{\"state\":\"success\", \"context\":\"tests\", \"description\":\"Docker CI tests passed\"}" \
    "https://api.github.com/repos/$REPO/statuses/$SHA" >/dev/null

echo "Pre-deploy hook complete — tests OK."

exit 0
