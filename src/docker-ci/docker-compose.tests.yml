services:
  postgres:
    image: postgres:18.0-alpine
    environment:
      POSTGRES_USER: mr_watchdog_test
      POSTGRES_PASSWORD: mr_watchdog_test_password
      POSTGRES_DB: mr_watchdog_test
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mr_watchdog_test"]
      interval: 2s
      timeout: 2s
      retries: 25

  tests:
    build:
      context: ..
      dockerfile: ./docker-ci/Dockerfile.tests
    environment:
      ReCaptcha__SiteKey: ${ReCaptcha__SiteKey}
      ReCaptcha__SecretKey: ${ReCaptcha__SecretKey}
      Logging__LogErrorApiSecret: 92a763ee-bc0c-49f9-bef4-f3bd7f03affb
      EmailAddresses__NoReply: noreply-test@mrwatchdog.com
      EmailAddresses__Support: support-test@mrwatchdog.com
      EmailAddresses__Admin: admin-test@mrwatchdog.com
      EmailAddresses__BackendErrors: backend-errors-test@mrwatchdog.com
      EmailAddresses__FrontendErrors: frontend-errors-test@mrwatchdog.com
      DatabaseConnectionStringName: TestDatabase
      DatabaseScriptsDirectoryPath: ../../../../DatabaseScripts
      Runtime__Url: https://mrwatchdog_test
      Runtime__Environment: Test
      Jwt__Key: a-long-random-secret-at-least-32-chars
      ConnectionStrings__TestDatabase: Host=postgres;Database=mr_watchdog_test;Username=mr_watchdog_test;Password=mr_watchdog_test_password;Include Error Detail=true;
      EmailSender__Service: NullEmailSender
      KickOffDueWatchdogsScrapingHostedService__IsDisabled: true
      Authentication__Google__ClientSecret: ${Authentication__Google__ClientSecret}
      Authentication__Google__ClientId: ${Authentication__Google__ClientId}

    depends_on:
      postgres:
        condition: service_healthy
